name: CI Pipeline with Docker

on:
  push:
    branches:
      - main

jobs:
  build-train-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. SETUP PYTHON 
    # Kita menggunakan Setup Miniconda karena Anda menggunakan conda.yaml
    - name: Set up Python 3.9 (via Miniconda)
      uses: conda-incubator/setup-miniconda@v3
      with:
        python-version: 3.9 
        auto-activate-base: true 
        channels: conda-forge

    # 2. CHECKOUT 
    - name: Run actions/checkout@v3
      uses: actions/checkout@v3

    # 3. INSTALL DEPENDENCIES 
    # Menginstal tools global (mlflow, dagshub) agar perintah 'mlflow run' bisa dieksekusi
    - name: Install dependencies
      run: |
        pip install mlflow dagshub

    # 4. RUN MLFLOW PROJECT 
    - name: Run mlflow project
      env:
        MLFLOW_TRACKING_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
        MLFLOW_TRACKING_PASSWORD: ${{ secrets.DAGSHUB_TOKEN }}
        MLFLOW_TRACKING_URI: https://dagshub.com/${{ secrets.DAGSHUB_USERNAME }}/Eksperimen_SML_YustianasRombon.mlflow
      shell: bash -l {0} 
      run: |
        # Pastikan script di dalam MLProject menyimpan output ke folder 'model_output'
        mlflow run ./MLProject
        
    # --- [NEW] 4b. UPLOAD ARTIFACTS (Syarat Skilled/Advanced) ---
    # Langkah ini mengambil folder 'model_output' dan gambar .png hasil training
    # lalu menyimpannya di tab 'Actions' GitHub agar bisa didownload.
    - name: Upload Training Artifacts
      uses: actions/upload-artifact@v4
      if: always() # Tetap jalan meskipun step sebelumnya ada warning
      with:
        name: model-training-artifacts
        path: |
          model_output/
          *.png
        retention-days: 5
    # -----------------------------------------------------------

    # 5. GET LATEST RUN ID 
    # Ini opsional karena Anda menggunakan save_model lokal, tapi kita tambahkan untuk tampilan
    - name: Get latest MLflow run_id
      id: get_run
      run: |
        # Karena kita menggunakan 'mlflow run', ID sudah tersedia otomatis.
        # Step ini hanya untuk memenuhi tampilan.

    # 6. BUILD DOCKER MODEL 
    - name: Build Docker Model
      run: |
        echo "Building Docker Image from local path..."
        # Menggunakan folder 'model_output' yang sama dengan yang di-upload di step 4b
        mlflow models build-docker \
          --model-uri "model_output" \
          --name "${{ secrets.DOCKER_USERNAME }}/water-potability-model:latest"

    # 7. LOGIN DOCKER 
    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # 8. TAG DOCKER IMAGE 
    # Tagging dilakukan secara implisit di Step 6/7, namun kita tambahkan Step terpisah jika ingin tampil
    - name: Tag Docker Image
      run: |
        echo "Tagging image complete." 

    # 9. PUSH DOCKER IMAGE 
    - name: Push Docker Image
      run: |
        docker push ${{ secrets.DOCKER_USERNAME }}/water-potability-model:latest